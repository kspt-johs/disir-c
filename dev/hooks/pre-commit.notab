#!/usr/bin/env ruby
require_relative '../local/githook.rb'

# https://www.ruby-forum.com/topic/122170#544763

class NoTab < GitHook

  def run
    @offending_lines = {}
    @git_files = `git diff --cached --name-only`.lines.map(&:chomp)
    collect_offending_lines
  end

  def collect_offending_lines
    @git_files.each do |file|
      next unless File.file?(file)
      next if File.binary?(file)

      verbose "Checking file '#{file}'"
      File.open(file) do |f|
        ln = 1
        lna = Array.new

        f.each_line do |line|
          lna.push ln  if line.match /\t/
          ln += 1
        end

        @offending_lines[file] = lna unless lna.empty?
      end
    end
  end

  def assert_no_offending_lines
    unless @offending_lines.empty?
      $stderr.puts "[POLICY]: Tab characters are illegal in source control."

      @offending_lines.each do |file, line_numbers|
        puts file
        line_numbers.each_slice(15).to_a.each { |sub_array| puts "\t" + sub_array.join(', ') }
        puts "\n"
      end

      exit 1
    end
  end
end

NoTab.hook ARGV
